(function(a){a.fn.uploadify=function(m){var n='<div id="${fileID}" class="uploadify-queue-item "><div class="uploadify-progress"><div class="uploadify-progress-bar"></div></div><span class="up_filename">${fileName}</span><span class="uploadbtn">上传</span><span class="delfilebtn">删除</span></div>';var j={fileTypeExts:"",uploader:"",auto:false,method:"post",multi:false,formData:{},fileObjName:"filedata",fileSizeLimit:2048,showUploadedPercent:true,showUploadedSize:false,buttonText:"",removeTimeout:1000,itemTemplate:n,breakPoints:false,isBurst:true,fileSplitSize:1024*1024,getFileSizeUrl:"",isCn:true,getUploadedSize:function b(v){var u=0;a.ajax({url:l.getFileSizeUrl,async:false,type:"post",dataType:"json",data:{fileMd5:v.md5,fileSplitSize:l.fileSplitSize,fileName:v.name,totalSize:v.size},success:function(w){if(w.success){u=w.size}else{u=-1;Fai.ing(w.msg)}}});return u},saveUploadedSize:null,saveInfoLocal:false,onUploadStart:null,onUploadSuccess:null,onUploadComplete:null,onUploadError:null,onInit:null,onCancel:null,onSelect:null};var l=a.extend(j,m);var q=function(u){l.uploader=u};var h=function(u,v){if(u>1024*1024&&!v){u=(Math.round(u*100/(1024*1024))/100).toString()+"MB"}else{u=(Math.round(u*100/1024)/100).toString()+"KB"}return u};var i=function(u,w){for(var v=0;v<w.length;v++){if(w[v].index==u){return w[v]}}return false};var e=function(y){var v=[];var w=y.split(";");for(var x=0,u=w.length;x<u;x++){v.push(w[x].split(".").pop())}return v};var t={zip:["application/x-zip-compressed"],jpg:["image/jpg"],jpeg:["image/jpeg"],png:["image/png"],gif:["image/gif"],bmp:["image/bmp"],doc:["application/msword"],xls:["application/vnd.ms-excel"],docx:["application/vnd.openxmlformats-officedocument.wordprocessingml.document"],xlsx:["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],ppt:["application/vnd.ms-powerpoint "],pptx:["application/vnd.openxmlformats-officedocument.presentationml.presentation"],mp3:["audio/mp3"],mp4:["video/mp4"],pdf:["application/pdf"],exe:["application/x-msdownload"],html:["text/html"],ico:["image/x-icon"],txt:["text/plain"],flv:[".flv"],swf:["application/x-shockwave-flash"],p12:["application/x-pkcs12"]};var s=function(u){return t[u]};var d=function(z){var x=e(z);var v=[];for(var w=0,u=x.length;w<u;w++){var y=s(x[w]);if(y){v.push(y)}}return v.join(",")};var g=function(v,y,x,u){y.open(l.method,v,true);y.setRequestHeader("X-Requested-With","XMLHttpRequest");var w=new FormData();w.append(l.fileObjName,x,x.name);if(u){for(key in u){w.append(key,u[key])}}y.send(w)};var p=90;function k(v){if(v.status=="start"){var A=['<div id="progressBody_'+v.id+'" class="bodyDisable"></div>','<div id="progressWrap_'+v.id+'" class="bodyProgressWrap">','<div class="progressCenter"></div>','<div class="progressIngBody">','<div id="progressTitle'+v.id+'" class="progressIngTitle">'+v.title+"</div>",'<div class="progressIngMission">','<div class="mission"><div id="progress'+v.id+'" class="progress" style="width:1%;"></div></div>','<div id="progressNum'+v.id+'" class="progressNum">0%</div>',"</div>",'<div class="progressInfo"><span class="progressFileSize">文件大小:'+Fai.parseFileSize(v.size)+'</span><a class="progressCancel" href="javascript:uploadCancel(\''+v.id+"');\">取消</a></div>","</div>","</div>"];a("body").append(A.join(""));p=90}else{if(v.status=="ing"){var x=v.percent;a("#progressTitle"+v.id).text(v.title);var z=o.fileFilter[0].name;var u=e(z)[0].toLowerCase();var y=s(u)==null?"":s(u)[0];if(v.percent>p&&v.percent!=100){var w=Math.random()/5;p+=parseFloat(w.toFixed(2));p=parseFloat(p.toFixed(2));x=p}if(y.indexOf("image")>=0){a("#progress"+v.id).css("width",x+"%");a("#progressNum"+v.id).html(x+"%")}else{a("#progress"+v.id).css("width",v.percent+"%");a("#progressNum"+v.id).html(v.percent+"%")}a("#progress"+v.id).attr("width",v.percent);if(y.indexOf("image")>=0){if(v.percent>99){c(v.id)}}}else{if(v.status=="end"){a("#progressTitle"+v.id).text(v.title);a("#progressBody_"+v.id).remove();a("#progressWrap_"+v.id).remove()}else{if(v.status=="error"){a("#progress"+v.id).addClass("progressError")}}}}}function c(u){if(p==90){return}p+=0.5;if(p>100){return}p=parseFloat(p.toFixed(2));a("#progress"+u).css("width",p+"%");a("#progressNum"+u).html(p+"%");setTimeout(function(){c(u)},1000)}function r(v,u){return v.indexOf(u,v.length-u.length)!==-1}var o=null;this.each(function(){var x=a(this);var u=a(".uploadify").length+1;var v='<a id="file_upload_'+u+'-button" href="javascript:void(0)" class="uploadify-button '+(l.isCn?"":"uploadify-buttonLan")+'">';v+=l.buttonText;v+="</a>";v+='<input id="select_btn_'+u+'" class="selectbtn" style="visibility:hidden;width:72px;" type="file" name="fileselect[]"';v+=l.multi?" multiple":"";v+=' accept="';if(l.fileTypeExts==null||l.fileTypeExts==""||l.fileTypeExts=="*"||l.fileTypeExts=="*.*;"){v+="*.*"}else{v+=d(l.fileTypeExts)}v+='"/>';var w='<div id="file_upload_'+u+'-queue" class="uploadify-queue"></div>';x.append(v);o={xhr:null,uploadAllowed:true,fileInput:x.find(".selectbtn"),uploadFileList:a(document).find(".uploadify-queue"),url:l.uploader,fileFilter:[],uploadOver:false,filter:function(E){var A=[];var z=false;var F=e(l.fileTypeExts);if(l.fileTypeExts==""||l.fileTypeExts=="*.*"||l.fileTypeExts==null||l.fileTypeExts=="*.*;"){z=true}if(F.length>0){for(var D=0,y=E.length;D<y;D++){var C=E[D];if(C.size>l.fileSizeLimit){if(l.siteFree){Fai.ing("免费版单个文件大小不超过"+l.fileSizeLimit/1024/1024+"MB，<a href='"+l.updateUrlViewRes+'\' target="_blank">点击了解各版本限制。</a>',true)}else{Fai.ing("单个文件不能超过"+l.fileSizeLimit/1024/1024+"MB",true)}continue}var B=C.name;if(l.siteFree){if(r(B,".apk")){Fai.ing("上传失败：您的版本目前不支持上传apk文件。",true);continue}if(r(B,".exe")){Fai.ing("上传失败：您的版本目前不支持上传exe文件。",true);continue}if((r(B,".html")||r(B,".htm"))){Fai.ing("上传失败：您的版本目前不支持上传html或htm文件。",true);continue}}if(!z){if(a.inArray(C.name.split(".").pop().toLowerCase(),F)>=0){A.push(C)}else{Fai.ing("文件"+C.name+"类型不允许！",true)}}else{A.push(C)}}}return A},funSelect:function(A){if(l.onSelect&&!l.onSelect(A)){o.fileFilter=[];return}if(l.breakPoints){var B=this.funGetUploadedSize(A[0])}if(B==-1){return}var z=(B/A[0].size*100).toFixed(2);var y={status:"start",id:A[0].id,title:"准备上传.....",percent:z,size:A[0].size};k(y);if(l.breakPoints){y={status:"ing",id:A[0].id,title:"正在上传.....",percent:z};k(y);this.funUploadFile(A[0])}},onProgress:function(z,C,H){var D=a("body").find("#progressWrap_"+z.id);var I=C;var y=D.attr("lastLoaded")||0;C-=parseInt(y);if(C<0){C=0}var E=a("#progress"+z.id);var A=l.breakPoints?parseFloat(E.attr("width")):0;if(C<z.size){return}var B=parseFloat(E.attr("old-loaded")||A/100*H);var G=B+z.size;E.attr("old-loaded",G);var F=(G/H*100).toFixed(0);F=F>=100?100:F;if(I<l.fileSplitSize){D.attr("lastLoaded",I)}else{D.removeAttr("lastLoaded")}tmpoptions={status:"ing",id:z.id,title:"正在上传.....",percent:F};k(tmpoptions)},funGetProgressWidth:function(y){},funGetUploadedSize:function(y){if(l.getUploadedSize){return l.getUploadedSize(y)}else{if(l.saveInfoLocal){return parseInt(localStorage.getItem(y.name))||0}}},funSaveUploadedSize:function(y,z){if(l.saveUploadedSize){l.saveUploadedSize(y,z)}else{if(l.saveInfoLocal){localStorage.setItem(y.name,z)}}},funGetFiles:function(B){var A=B.target.files;A=this.filter(A);for(var z=0,y=A.length;z<y;z++){this.fileFilter.push(A[z])}if(this.fileFilter.length==0){a(this.fileInput).val("");return}this.funDealFiles(A);return this},funDealFiles:function(A){var B=a(document).find(".uploadify-queue .uploadify-queue-item").length;for(var z=0,y=A.length;z<y;z++){A[z].index=++B;A[z].id="fileupload_"+u+"_"+A[z].index;A[z].md5=a.md5(A[z].name+A[z].size+A[z].type+A[z].lastModified);if(l.isBurst){if(A[z].size>=0&&A[z].size<20<<10<<10){l.fileSplitSize=5<<10<<10}else{if(A[z].size>=20<<10<<10&&A[z].size<50<<10<<10){l.fileSplitSize=5<<10<<10}else{if(A[z].size>=50<<10<<10&&A[z].size<100<<10<<10){l.fileSplitSize=8<<10<<10}else{if(A[z].size>=100<<10<<10&&A[z].size<500<<10<<10){l.fileSplitSize=10<<10<<10}else{l.fileSplitSize=15<<10<<10}}}}}else{}}this.funSelect(A);return this},funDeleteFile:function(z){for(var B=0,y=this.fileFilter.length;B<y;B++){var A=this.fileFilter[B];if(A.index==z){if(l.breakPoints){this.uploadAllowed=false}this.fileFilter.splice(B,1);a(document).find("#fileupload_"+u+"_"+z).fadeOut();o.fileInput.val("");l.onCancel&&l.onCancel(A);break}}return this},funUploadFile:function(D){o.xhr=new XMLHttpRequest();var K=D;var A=false;var y=a(document).find("#fileupload_"+u+"_"+D.index);var H=function(){if(o.uploadOver){y.find(".uploadify-progress-bar").css("width","100%");l.showUploadedSize&&y.find(".uploadedsize").text(y.find(".totalsize").text());l.showUploadedPercent&&y.find(".up_percent").text("100%");l.onUploadSuccess&&l.onUploadSuccess(K,o.xhr.responseText);o.funDeleteFile(D.index);setTimeout(I,1500)}};var I=function(){if(o.fileFilter.length!=0){var N=o.funGetUploadedSize(o.fileFilter[0]);var M=(N/o.fileFilter[0].size*100);var L={status:"start",id:o.fileFilter[0].id,title:"准备上传.....",percent:M,size:o.fileFilter[0].size};k(L);L={status:"ing",id:o.fileFilter[0].id,title:"正在上传.....",percent:M};k(L);o.funUploadFile(o.fileFilter[0])}};try{o.xhr=new XMLHttpRequest()}catch(J){o.xhr=ActiveXobject("Msxml12.XMLHTTP")}if(l.breakPoints){var F=D.name,C=D.id,B=D.index,E=D.size,G=D.md5;var z=parseInt(this.funGetUploadedSize(K));if(E>=l.fileSplitSize){D=K.slice(z,z+l.fileSplitSize);A=false;o.lastSplit=false}else{A=true;o.lastSplit=true}D.name=F;D.id=C;D.index=B;D.md5=G}if(o.xhr.upload&&z!==false){o.xhr.upload.addEventListener("progress",function(L){o.onProgress(D,L.loaded,K.size)},false);o.xhr.onreadystatechange=function(){if(o.xhr.readyState==4){o.uploadOver=true;if(o.xhr.status==200){var M=JSON.parse(o.xhr.responseText);if(M.success){if(l.breakPoints){z+=l.fileSplitSize;o.funSaveUploadedSize(K,z>=E?E:z);if(z<E){o.uploadOver=false;if(o.uploadAllowed){if((z+l.fileSplitSize)>=E){D=K.slice(z,E);A=true}else{D=K.slice(z,z+l.fileSplitSize);A=false}D.name=F;D.id=C;D.index=B;D.size=E;l.formData.fileMd5=K.md5;l.formData.totalSize=K.size;l.formData.complete=A;l.formData.initSize=z;setTimeout(g(o.url,o.xhr,D,l.formData),2000)}}else{H()}}else{H()}}else{Fai.ing("文件："+D.name+"  "+M.msg,true);var L={status:"end",id:D.id};k(L);o.uploadOver=true;H()}}else{o.uploadOver&&l.onUploadError&&l.onUploadError(K,o.xhr.responseText)}if(o.uploadOver){l.onUploadComplete&&l.onUploadComplete(K,o.xhr.responseText);o.fileInput.val("");p=90}}};l.onUploadStart&&l.onUploadStart(D);l.formData.fileMd5=D.md5;l.formData.totalSize=K.size;l.formData.complete=A;l.formData.initSize=z;o.uploadAllowed=true;f(l.post_params);g(o.url,o.xhr,D,l.formData)}},init:function(){if(this.fileInput.length>0){this.fileInput.change(function(y){o.funGetFiles(y)})}x.find(".uploadify-button").on("click",function(){x.find(".selectbtn").trigger("click")});l.onInit&&l.onInit()}};o.init()});function f(v){var u=l.uploader;for(key in v){u+="&"+key+"="+v[key]}o.url=u}return{genUploadUrl:f,stop:function(){o.xhr.abort();o.uploadOver=false;o.uploadAllowed=false;for(var v=0,u=o.fileFilter.length;v<u;v++){o.funDeleteFile(++v)}o.fileFilter=[]},upload:function(x){if(x==="*"){var u=u=o.fileFilter.length;for(var w=0,u=o.fileFilter.length;w<u;w++){o.funUploadFile(o.fileFilter[w])}}else{var v=i(x,o.fileFilter);v&&o.funUploadFile(v)}},cancel:function(w){w="*";if(w=="*"){for(var v=0,u=o.fileFilter.length;v<u;v++){o.funDeleteFile(++v)}}else{o.funDeleteFile(w)}},disable:function(v){var u=v?a("file_upload_"+v+"-button"):a("body");u.find(".uploadify-button").css("background-color","#888").off("click")},ennable:function(v){var u=v?a("file_upload_"+v+"-button"):a("body");u.find(".uploadify-button").css("background-color","#707070").on("click",function(){u.find(".selectbtn").trigger("click")})}}}})(jQuery);